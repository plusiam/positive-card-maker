<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¦¬ë¯¸ì—„ ê¸ì • ì¹´ë“œ ë©”ì´ì»¤ v3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Noto+Sans+KR:wght@400;500;700&family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-handwriting { font-family: 'Gaegu', cursive; }
        .font-dodum { font-family: 'Gowun Dodum', sans-serif; }
        .roulette-needle { transform-origin: bottom center; transition: transform 2s cubic-bezier(0.25, 1, 0.5, 1); }
        
        [contenteditable=true]:empty:before {
            content: attr(placeholder);
            pointer-events: none;
            display: block;
            color: #9ca3af;
        }
        
        .template-card {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .template-card.selected {
            ring: 3px;
            ring-color: #3b82f6;
            transform: scale(1.05);
        }
        
        .template-card:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        .canvas-container {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .image-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
        
        .image-upload-area.dragover {
            border-color: #10b981;
            background-color: #ecfdf5;
        }
        
        .image-upload-area:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        /* ìŠ¬ë¡¯ ì• ë‹ˆë©”ì´ì…˜ */
        .slot-added { animation: slotPulse 0.6s ease-out; }
        @keyframes slotPulse {
            0% { background-color: #dcfce7; transform: scale(1); }
            50% { background-color: #bbf7d0; transform: scale(1.02); }
            100% { background-color: #f9fafb; transform: scale(1); }
        }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ì—ëŸ¬ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            display: none;
        }
        
        /* ë¡œë”© ìƒíƒœ */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* í…œí”Œë¦¿ ë°°ê²½ë“¤ */
        .template-pastel { background: linear-gradient(135deg, #fef3c7 0%, #fce7f3 50%, #dbeafe 100%); }
        .template-sunrise { background: linear-gradient(135deg, #fed7aa 0%, #fecaca 50%, #fde68a 100%); }
        .template-ocean { background: linear-gradient(135deg, #bfdbfe 0%, #a7f3d0 50%, #c7d2fe 100%); }
        .template-pink { background: linear-gradient(135deg, #fce7f3 0%, #fed7e2 50%, #fef3c7 100%); }
        .template-nature { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #fef3c7 100%); }
        .template-purple { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #fce7f3 100%); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- í—¤ë” -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-gray-800 font-handwriting">ğŸ’Œ í”„ë¦¬ë¯¸ì—„ ê¸ì • ì¹´ë“œ ë©”ì´ì»¤</h1>
                <p class="text-lg text-gray-600 mt-2">ì•„ë¦„ë‹¤ìš´ í…œí”Œë¦¿ê³¼ ì´ë¯¸ì§€ë¡œ ë‚˜ë§Œì˜ íŠ¹ë³„í•œ ì¹´ë“œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
            </div>
        </div>
    </header>

    <!-- ì—ëŸ¬ ë©”ì‹œì§€ ì˜ì—­ -->
    <div id="error-container" class="max-w-7xl mx-auto px-4 pt-4">
        <div id="error-message" class="error-message" role="alert" aria-live="polite"></div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            
            <!-- ì™¼ìª½: ë©”ì‹œì§€ ë½‘ê¸° & ì¡°í•© -->
            <div class="xl:col-span-2 space-y-6">
                
                <!-- ë©”ì‹œì§€ ë½‘ê¸° ì„¹ì…˜ -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">ğŸ² í–‰ìš´ì˜ ë©”ì‹œì§€ ë½‘ê¸°</h2>
                    <div class="text-center space-y-4">
                        <div class="relative w-48 h-48 mx-auto bg-gradient-to-br from-yellow-200 via-pink-200 to-sky-200 rounded-full flex items-center justify-center shadow-inner" role="img" aria-label="í–‰ìš´ì˜ ë£°ë ›">
                            <div id="roulette-needle" class="roulette-needle absolute w-2 h-24 bg-red-500 rounded-t-full bottom-1/2 shadow-lg border-2 border-white"></div>
                            <div class="w-8 h-8 bg-white rounded-full z-10 border-4 border-red-500"></div>
                        </div>
                        <button id="btn-spin" class="bg-green-500 text-white font-bold py-3 px-8 rounded-xl hover:bg-green-600 transition-colors text-xl shadow-md font-handwriting focus:outline-none focus:ring-2 focus:ring-green-400" aria-label="ê¸ì • ë©”ì‹œì§€ ë£°ë › ëŒë¦¬ê¸°">ğŸ€ ë©”ì‹œì§€ ë½‘ê¸°</button>
                        <div class="bg-gray-50 p-4 rounded-xl min-h-[6rem] flex items-center justify-center text-center">
                            <p id="todays-phrase" class="text-2xl text-gray-800 font-medium font-dodum" aria-live="polite">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”!</p>
                        </div>
                        <button id="btn-add-phrase" class="hidden bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors text-lg shadow font-handwriting focus:outline-none focus:ring-2 focus:ring-blue-400" aria-label="í˜„ì¬ ë©”ì‹œì§€ë¥¼ ì¹´ë“œì— ì¶”ê°€í•˜ê¸°">â• ì´ ë¬¸êµ¬ ì¶”ê°€í•˜ê¸°</button>
                    </div>
                </div>

                <!-- ì¡°í•© ì¹´ë“œ ì„¹ì…˜ -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">ğŸ“ ë‚˜ë§Œì˜ ì¡°í•© ì¹´ë“œ <span id="slot-status" class="text-gray-500 font-normal" aria-live="polite">(0/5)</span></h2>
                    <div id="combination-box" class="space-y-3" role="list" aria-label="ì„ íƒëœ ë©”ì‹œì§€ ëª©ë¡"></div>
                </div>

                <!-- ì¹´ë“œ ì„¤ì • ì„¹ì…˜ -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">âš™ï¸ ì¹´ë“œ ì„¤ì •</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="input-to" class="block text-gray-700 font-medium mb-2">ë°›ëŠ” ì‚¬ëŒ:</label>
                            <input type="text" id="input-to" placeholder="ì˜ˆ: ì†Œì¤‘í•œ ë‚˜ì—ê²Œ" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" aria-describedby="input-to-help">
                            <p id="input-to-help" class="text-sm text-gray-500 mt-1">ì¹´ë“œì˜ ë°›ëŠ” ì‚¬ëŒì„ ì…ë ¥í•˜ì„¸ìš”</p>
                        </div>
                        <div>
                            <label for="input-from" class="block text-gray-700 font-medium mb-2">ë³´ë‚´ëŠ” ì‚¬ëŒ:</label>
                            <input type="text" id="input-from" placeholder="ì˜ˆ: ë„ˆì˜ ì¢‹ì€ ì¹œêµ¬" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" aria-describedby="input-from-help">
                            <p id="input-from-help" class="text-sm text-gray-500 mt-1">ì¹´ë“œì˜ ë³´ë‚´ëŠ” ì‚¬ëŒì„ ì…ë ¥í•˜ì„¸ìš”</p>
                        </div>
                    </div>

                    <!-- í…œí”Œë¦¿ ì„ íƒ -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-3">í…œí”Œë¦¿ ì„ íƒ:</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="template-selection" role="radiogroup" aria-label="ì¹´ë“œ í…œí”Œë¦¿ ì„ íƒ">
                            <div class="template-card template-pastel w-full h-20 rounded-lg border-2 border-gray-200" data-template="pastel" role="radio" aria-checked="true" tabindex="0" aria-label="íŒŒìŠ¤í…” ë“œë¦¼ í…œí”Œë¦¿">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">íŒŒìŠ¤í…” ë“œë¦¼</div>
                            </div>
                            <div class="template-card template-sunrise w-full h-20 rounded-lg border-2 border-gray-200" data-template="sunrise" role="radio" aria-checked="false" tabindex="-1" aria-label="ë”°ëœ»í•œ ì¼ì¶œ í…œí”Œë¦¿">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ë”°ëœ»í•œ ì¼ì¶œ</div>
                            </div>
                            <div class="template-card template-ocean w-full h-20 rounded-lg border-2 border-gray-200" data-template="ocean" role="radio" aria-checked="false" tabindex="-1" aria-label="ì²­ëŸ‰í•œ ë°”ë‹¤ í…œí”Œë¦¿">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ì²­ëŸ‰í•œ ë°”ë‹¤</div>
                            </div>
                            <div class="template-card template-pink w-full h-20 rounded-lg border-2 border-gray-200" data-template="pink" role="radio" aria-checked="false" tabindex="-1" aria-label="ë¡œë§¨í‹± í•‘í¬ í…œí”Œë¦¿">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ë¡œë§¨í‹± í•‘í¬</div>
                            </div>
                            <div class="template-card template-nature w-full h-20 rounded-lg border-2 border-gray-200" data-template="nature" role="radio" aria-checked="false" tabindex="-1" aria-label="ìì—° ê·¸ë¦° í…œí”Œë¦¿">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ìì—° ê·¸ë¦°</div>
                            </div>
                            <div class="template-card template-purple w-full h-20 rounded-lg border-2 border-gray-200" data-template="purple" role="radio" aria-checked="false" tabindex="-1" aria-label="ìš°ì•„í•œ í¼í”Œ í…œí”Œë¦¿">
                                <div class="w-full h-full rounded-lg flex items-center justify-center text-sm font-medium text-gray-700">ìš°ì•„í•œ í¼í”Œ</div>
                            </div>
                        </div>
                    </div>

                    <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-3">ë°°ê²½ ì´ë¯¸ì§€ (ì„ íƒì‚¬í•­):</label>
                        <div id="image-upload-area" class="image-upload-area p-8 text-center" tabindex="0" role="button" aria-label="ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­">
                            <input type="file" id="image-input" class="hidden" accept="image/jpeg,image/png,image/gif,image/webp" aria-label="ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ">
                            <div id="upload-placeholder">
                                <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <p class="text-gray-600">í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•´ì„œ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                                <p class="text-sm text-gray-400 mt-2">JPG, PNG, GIF, WebP íŒŒì¼ ì§€ì› (ìµœëŒ€ 10MB)</p>
                            </div>
                            <div id="image-preview" class="hidden">
                                <img id="preview-img" class="max-w-full max-h-32 mx-auto rounded-lg" alt="ì—…ë¡œë“œëœ ë°°ê²½ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
                                <button id="remove-image" class="mt-2 text-red-500 hover:text-red-700 text-sm focus:outline-none focus:ring-2 focus:ring-red-400" aria-label="ë°°ê²½ ì´ë¯¸ì§€ ì œê±°">âœ• ì´ë¯¸ì§€ ì œê±°</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° -->
            <div class="bg-white p-6 rounded-2xl shadow-lg sticky top-8">
                <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">ğŸ–¼ï¸ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°</h2>
                
                <div class="canvas-container mb-4">
                    <canvas id="preview-canvas" width="400" height="600" class="w-full h-auto rounded-lg" aria-label="ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€"></canvas>
                </div>

                <div class="space-y-3">
                    <button id="btn-download" class="w-full bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600 transition-colors text-lg shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed font-handwriting focus:outline-none focus:ring-2 focus:ring-purple-400" disabled aria-label="ì™„ì„±ëœ ì¹´ë“œë¥¼ ì´ë¯¸ì§€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ">ğŸ“¥ ì´ë¯¸ì§€ë¡œ ë‹¤ìš´ë¡œë“œ</button>
                    <button id="btn-create-new" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors font-handwriting focus:outline-none focus:ring-2 focus:ring-gray-400" aria-label="ìƒˆë¡œìš´ ì¹´ë“œ ë§Œë“¤ê¸°">ğŸ”„ ìƒˆë¡œ ë§Œë“¤ê¸°</button>
                </div>

                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-bold text-blue-800 mb-2">ğŸ’¡ ì œì‘ ê°€ì´ë“œ</h3>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>â€¢ ë£°ë ›ìœ¼ë¡œ ì˜ê°ì„ ë°›ì•„ë³´ì„¸ìš”</li>
                        <li>â€¢ ì—¬ëŸ¬ ë©”ì‹œì§€ë¥¼ ì¡°í•©í•´ë³´ì„¸ìš”</li>
                        <li>â€¢ í…œí”Œë¦¿ì„ ì„ íƒí•˜ê³  ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•˜ì„¸ìš”</li>
                        <li>â€¢ ì™„ì„±ëœ ì¹´ë“œë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ì„¸ìš”</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const positivePhrases = ["ë‚˜ëŠ” ì„¸ìƒì—ì„œ ê°€ì¥ ì†Œì¤‘í•œ ì¡´ì¬ì•¼.", "ìˆëŠ” ê·¸ëŒ€ë¡œì˜ ë„ˆë¥¼ ì‚¬ë‘í•´.", "ë„ˆì˜ ì¡´ì¬ëŠ” ê·¸ ìì²´ë¡œ ì„ ë¬¼ì´ì•¼.", "ìŠ¤ìŠ¤ë¡œë¥¼ ë”°ëœ»í•˜ê²Œ ì•ˆì•„ì£¼ì.", "ë‚˜ì˜ ë§ˆìŒê³¼ í•˜ì´íŒŒì´ë¸Œ!", "ë‚´ ë§ˆìŒì˜ í–‰ë³µí•œ ì£¼ì¸ì€ ë°”ë¡œ ë‚˜ì•¼.", "ë„ˆëŠ” í˜¼ìê°€ ì•„ë‹ˆì•¼, ì£¼ìœ„ë¥¼ ë‘˜ëŸ¬ë´.", "ë„ˆ ìì‹ ì„ ë¯¿ì–´ë´, ë„Œ ìƒê°ë³´ë‹¤ ê°•í•´.", "ë‹¤ë¥¸ ì‚¬ëŒê³¼ ë¹„êµí•˜ì§€ ì•Šì•„ë„ ê´œì°®ì•„.", "ë„ˆì˜ ëª¨ë“  ìˆœê°„ì„ ì‘ì›í•´.", "ë‚˜ëŠ” ë‚˜ì˜ ê°€ì¥ ì¢‹ì€ ì¹œêµ¬ì•¼.", "ë‚´ ë§ˆìŒì˜ ì†Œë¦¬ì— ê·€ ê¸°ìš¸ì—¬ì£¼ì.", "ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í•œ ë‚˜ì—ê²Œ 'ê³ ë§ˆì›Œ'.", "ë‚˜ì˜ ê°ì •ì€ ëª¨ë‘ ì†Œì¤‘í•˜ê³  ì˜ë¯¸ìˆì–´.", "ë‚˜ë¥¼ ìœ„í•œ ì‘ì€ íœ´ì‹ ì‹œê°„ì„ ì„ ë¬¼í•˜ì.", "ë„ˆëŠ” ì¶©ë¶„íˆ ì‚¬ë‘ë°›ì„ ìê²©ì´ ìˆì–´.", "ìƒê°ì„ ë°”ê¾¸ë©´, ê¸°ë¶„ë„ ë°”ê¿€ ìˆ˜ ìˆì–´.", "'ê·¸ë˜ë„ ì¢‹ì•„!'ë¼ê³  ì™¸ì³ë´.", "ë§¤ì¼ í–‰ë³µí•˜ì§„ ì•Šì§€ë§Œ, í–‰ë³µí•œ ì¼ì€ ë§¤ì¼ ìˆì–´.", "ê±±ì • ëŒ€ì‹  ê¸°ëŒ€ë¥¼ ì±„ì›Œë³´ì.", "ë¬¸ì œ ì†ì— ìˆ¨ê²¨ì§„ ê¸°íšŒë¥¼ ì°¾ì•„ë´.", "ë¹„ê°€ ì™€ë„ ì¢‹ì•„, ë§‘ì•„ë„ ì¢‹ì•„.", "ê´œì°®ì•„, ë°©ë²•ì€ ì–¸ì œë‚˜ ìˆì–´.", "ëª¨ë“  ê²ƒì—ëŠ” ê¸ì •ì ì¸ ë©´ì´ ìˆ¨ì–´ìˆì–´.", "ë‚˜ì—ê²Œ í˜ì„ ì£¼ëŠ” ê¸ì • ë©”ì‹œì§€ë¥¼ ë§Œë“¤ì–´ë´.", "ì›ƒìœ¼ë©´ ê¸°ë¶„ë„ ì¢‹ì•„ì§„ëŒ€.", "ëª¨ë“  ì¼ì€ ìƒê°í•˜ê¸° ë‚˜ë¦„ì´ì•¼.", "í•˜ëŠ˜ í•œë²ˆ ë³´ê³  í¬ê²Œ ìˆ¨ ì‰¬ì–´ë´.", "ê±±ì • êµ¬ë¦„ì„ í›…~ ë¶ˆì–´ì„œ ë‚ ë ¤ë²„ë¦¬ì.", "ë§ˆìŒì†ì— ê¸ì • ì—ë„ˆì§€ë¥¼ ê°€ë“ ì±„ì›Œë´!", "'í•  ìˆ˜ ì—†ë‹¤'ëŠ” ìƒê° ëŒ€ì‹  'ì–´ë–»ê²Œ í• ê¹Œ?'ë¥¼ ìƒê°í•˜ì.", "ì‹¤ìˆ˜í•´ë„ ê´œì°®ì•„, ê·¸ê²ƒë„ ë°°ìš°ëŠ” ê³¼ì •ì´ì•¼.", "ë„˜ì–´ì ¸ë„ ê´œì°®ì•„, íˆ­íˆ­ í„¸ê³  ì¼ì–´ë‚˜ì.", "ì§€ê¸ˆì˜ ì–´ë ¤ì›€ì€ ë„ˆë¥¼ ë” ë‹¨ë‹¨í•˜ê²Œ ë§Œë“¤ ê±°ì•¼.", "ë°”ê¿€ ìˆ˜ ì—†ëŠ” ì¼ì€ ì¿¨í•˜ê²Œ ë°›ì•„ë“¤ì´ì.", "ì‘ì€ ì„±ê³µ í•˜ë‚˜ë¥¼ ìŠ¤ìŠ¤ë¡œ ì¶•í•˜í•´ì£¼ì.", "ì˜í–ˆê³ , ì˜í•˜ê³  ìˆê³ , ì•ìœ¼ë¡œë„ ì˜ ë  ê±°ì•¼.", "í¬ê¸°í•˜ì§€ ì•ŠëŠ” ë„ˆì˜ ëª¨ìŠµì´ ê°€ì¥ ë©‹ì ¸.", "ë„ˆì˜ ê°€ëŠ¥ì„±ì€ ë¬´í•œëŒ€ì•¼.", "ì–´ì œì˜ ë„ˆë³´ë‹¤ í•œ ë¼˜ ë” ì„±ì¥í–ˆì–´.", "ë‘ë ¤ì›Œë„ ê´œì°®ì•„, ê·¸ê±´ ìš©ê¸°ì˜ ì²«ê±¸ìŒì´ë‹ˆê¹Œ.", "ê´œì°®ì•„, ì§€ê¸ˆ ì†ë„ë„ ì¶©ë¶„íˆ ë©‹ì ¸.", "ì‘ì€ ë¬¼ë°©ìš¸ì´ ëª¨ì—¬ ë°”ìœ„ë¥¼ ëš«ëŠ” ë²•ì´ì•¼.", "ì•„ì£¼ ì‘ì€ ì”¨ì•—ì´ í° ë‚˜ë¬´ê°€ ë  ìˆ˜ ìˆì–´.", "í”ë“¤ë ¤ë„ ê´œì°®ì•„, êº¾ì´ì§€ë§Œ ì•Šìœ¼ë©´ ë¼.", "ìƒˆë¡œìš´ ë„ì „ì„ ì¦ê²¨ë´, ë„Œ í•  ìˆ˜ ìˆì–´!", "ë„ˆì˜ ê¿ˆì„ í–¥í•´ ì˜¤ëŠ˜ í•œ ê±¸ìŒ ë”!", "ë°°ì›€ì—ëŠ” ëì´ ì—†ì–´, ì¦ê²ê²Œ íƒí—˜í•˜ì!", "ì–´ì œì˜ ì‹¤ìˆ˜ëŠ” ì˜¤ëŠ˜ì˜ ì§€í˜œê°€ ë  ê±°ì•¼.", "ë„ˆì˜ ê°€ëŠ¥ì„±ì€ ë³„ë“¤ì²˜ëŸ¼ ë§ì•„.", "ëª¨ë¥´ëŠ” ê±´ ë¶€ë„ëŸ¬ìš´ ê²Œ ì•„ë‹ˆì•¼, ë¬¼ì–´ë³¼ ìˆ˜ ìˆëŠ” ìš©ê¸°!", "ì˜¤ëŠ˜ ë‚´ê°€ í•  ìˆ˜ ìˆëŠ” ì‘ì€ ì¼ í•˜ë‚˜ë¥¼ í•´ë³´ì.", "ë„ˆì˜ í˜¸ê¸°ì‹¬ì„ ë”°ë¼ê°€ ë´.", "ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ì•„, ê³¼ì •ì´ ì¤‘ìš”í•´.", "ë„ˆë§Œì˜ ìƒ‰ê¹”ë¡œ ì„¸ìƒì„ ì¹ í•´ë´.", "í•œê³„ë¥¼ ì •í•˜ëŠ” ì‚¬ëŒì€ ë„ˆ ìì‹ ë¿ì´ì•¼.", "ë„ˆëŠ” ë„ˆì˜ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ê°€ëŠ” ì£¼ì¸ê³µì´ì•¼.", "ì˜¤ëŠ˜ì€ ì–´ë–¤ ì‹ ë‚˜ëŠ” ì¼ì„ ë§Œë“¤ì–´ë³¼ê¹Œ?", "ìƒˆë¡œìš´ ê¸¸ì„ ê°€ëŠ” ê²ƒì„ ë‘ë ¤ì›Œí•˜ì§€ ë§ˆ.", "ì‘ì€ ë…¸ë ¥ì´ ëª¨ì—¬ í° ë³€í™”ë¥¼ ì´ë£¬ë‹¤.", "ì¹œêµ¬ì—ê²Œ ë”°ëœ»í•œ ë§ í•œë§ˆë””ë¥¼ ê±´ë„¤ë´.", "'ê³ ë§ˆì›Œ', 'ë¯¸ì•ˆí•´'ë¼ê³  í‘œí˜„í•˜ëŠ” ìš©ê¸°.", "í˜ë“¤ ë• 'ë„ì™€ì¤˜!'ë¼ê³  ë§í•´ë„ ê´œì°®ì•„.", "í•¨ê»˜í•˜ë©´ ë” ì¦ê²ê³ , í˜ì€ ë°˜ìœ¼ë¡œ ì¤„ì–´.", "ë„ˆì˜ ë§ˆìŒì„ ì†”ì§í•˜ê²Œ ë³´ì—¬ì¤˜.", "ìš°ë¦¬ëŠ” ì„œë¡œì—ê²Œ í˜ì´ ë˜ëŠ” ì¡´ì¬ì•¼.", "ì¹œêµ¬ì˜ ë§ˆìŒì— ê³µê°í•´ì£¼ì.", "ë„ˆì˜ ì´ì•¼ê¸°ë¥¼ ê·€ ê¸°ìš¸ì—¬ ë“¤ì–´ì¤„ê²Œ.", "ìš°ë¦¬ ê°™ì´ í•´ë³¼ê¹Œ?", "ë„ˆì™€ í•¨ê»˜ë¼ì„œ ê¸°ë».", "ì¹œêµ¬ì˜ ì¢‹ì€ ì ì„ ë°œê²¬í•˜ê³  ì¹­ì°¬í•´ì£¼ì.", "ë„ˆì˜ ì§„ì‹¬ì€ ë¶„ëª… í†µí•  ê±°ì•¼.", "ìš°ë¦¬ ì‚¬ì´ì˜ ë¯¿ìŒì€ ê°€ì¥ í° í˜ì´ì•¼.", "ë¨¼ì € ì›ƒìœ¼ë©° ì¸ì‚¬í•´ë³¼ê¹Œ?", "ìš°ë¦¬ëŠ” ê°™ì€ í¸ì´ì•¼.", "ì˜¤ëŠ˜ í•˜ëŠ˜ì€ ë¬´ìŠ¨ ìƒ‰ì´ì—ˆì–´?", "ë§›ìˆëŠ” ê°„ì‹ì„ ë¨¹ëŠ” í–‰ë³µì„ ì¦ê²¨ë´.", "ì¢‹ì•„í•˜ëŠ” ë…¸ë˜ë¥¼ í¬ê²Œ ë”°ë¼ ë¶ˆëŸ¬ë´.", "í–‡ì‚´ ì¢‹ì€ ë‚ , ì ì‹œ ì°½ë°–ì„ ë°”ë¼ë³´ëŠ” ì—¬ìœ .", "ì˜¤ëŠ˜ ë„ˆë¥¼ ì›ƒê²Œ í•œ ì¼ì€ ë­ì˜€ì–´?", "í‘¹ì‹ í•œ ì´ë¶ˆ ì†ì—ì„œ ë’¹êµ´ë’¹êµ´~", "ì‹œì›í•œ ë°”ëŒì´ ê¸°ë¶„ ì¢‹ê²Œ ëŠê»´ì§€ëŠ” ìˆœê°„.", "ë‚´ê°€ ì¢‹ì•„í•˜ëŠ” í–¥ê¸°ë¥¼ ë§¡ì•„ë´.", "ì‘ì€ ì‹ë¬¼ì— ë¬¼ì„ ì£¼ë©° ìƒëª…ì„ ëŠê»´ë´.", "ì˜¤ëŠ˜ í•˜ë£¨, ë‚˜ì—ê²Œ ì‘ì€ ì„ ë¬¼ì„ í•´ë³´ì.", "ì°½ë¬¸ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” í–‡ì‚´ì„ ëŠê»´ë´.", "ì¢‹ì•„í•˜ëŠ” ìºë¦­í„° ê·¸ë¦¼ì„ ê·¸ë ¤ë³¼ê¹Œ?", "ë©í•˜ë‹ˆ êµ¬ë¦„ ëª¨ì–‘ì„ ìƒìƒí•´ë´.", "ì‚¬ê°ì‚¬ê° ì—°í•„ ì†Œë¦¬ì— ì§‘ì¤‘í•´ë´.", "ì±…ì˜ ìƒˆë¡œìš´ í˜ì´ì§€ë¥¼ ë„˜ê¸°ëŠ” ì„¤ë ˜.", "ì˜¤ëŠ˜ ë¨¹ê³  ì‹¶ì€ ê±° ìˆì–´? ë§›ìˆê²Œ ë¨¹ì!", "ì •ë¦¬ëœ ì±…ìƒì„ ë³´ë©° ë¿Œë“¯í•´í•˜ê¸°.", "ë¹—ì†Œë¦¬ë¥¼ ë“¤ìœ¼ë©° ì¢‹ì•„í•˜ëŠ” ì±… ì½ê¸°.", "ì¹œêµ¬ì™€ ëˆˆ ë§ˆì£¼ì¹˜ë©° ì›ƒê¸°.", "ê°“ ë‚˜ì˜¨ ë¹µ ëƒ„ìƒˆ ë§¡ê¸°.", "ë³´ë“¤ë³´ë“¤í•œ ë‹´ìš”ì˜ ê°ì´‰ ëŠë¼ê¸°.", "ì‹œì›í•œ ë¬¼ í•œ ì” ë§ˆì‹œê¸°.", "ì˜¤ëŠ˜ ê°ì‚¬í•œ ì¼ 3ê°€ì§€ë¥¼ ë– ì˜¬ë ¤ë´.", "ë„ˆì˜ í•˜ë£¨ê°€ ë³„ì²˜ëŸ¼ ë°˜ì§ì´ê¸¸.", "í–‰ë³µì€ ë©€ë¦¬ ìˆì§€ ì•Šì•„, ë°”ë¡œ ì—¬ê¸° ìˆì–´."];
        const MAX_SLOTS = 5;
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

        // í…œí”Œë¦¿ ì •ì˜
        const templates = {
            pastel: {
                background: 'linear-gradient(135deg, #fef3c7 0%, #fce7f3 50%, #dbeafe 100%)',
                textColor: '#374151'
            },
            sunrise: {
                background: 'linear-gradient(135deg, #fed7aa 0%, #fecaca 50%, #fde68a 100%)',
                textColor: '#451a03'
            },
            ocean: {
                background: 'linear-gradient(135deg, #bfdbfe 0%, #a7f3d0 50%, #c7d2fe 100%)',
                textColor: '#1e3a8a'
            },
            pink: {
                background: 'linear-gradient(135deg, #fce7f3 0%, #fed7e2 50%, #fef3c7 100%)',
                textColor: '#831843'
            },
            nature: {
                background: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #fef3c7 100%)',
                textColor: '#14532d'
            },
            purple: {
                background: 'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #fce7f3 100%)',
                textColor: '#581c87'
            }
        };

        // --- DOM ìš”ì†Œ ---
        const needle = document.getElementById('roulette-needle');
        const btnSpin = document.getElementById('btn-spin');
        const todaysPhrase = document.getElementById('todays-phrase');
        const btnAddPhrase = document.getElementById('btn-add-phrase');
        const combinationBox = document.getElementById('combination-box');
        const slotStatus = document.getElementById('slot-status');
        const inputTo = document.getElementById('input-to');
        const inputFrom = document.getElementById('input-from');
        const btnDownload = document.getElementById('btn-download');
        const btnCreateNew = document.getElementById('btn-create-new');
        const canvas = document.getElementById('preview-canvas');
        const ctx = canvas.getContext('2d');
        const templateSelection = document.getElementById('template-selection');
        const imageInput = document.getElementById('image-input');
        const imageUploadArea = document.getElementById('image-upload-area');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const removeImageBtn = document.getElementById('remove-image');
        const errorMessage = document.getElementById('error-message');

        // --- ìƒíƒœ ê´€ë¦¬ ---
        let selectedPhrases = new Array(MAX_SLOTS).fill('');
        let isSpinning = false;
        let currentDrawnPhrase = '';
        let selectedTemplate = 'pastel';
        let backgroundImage = null;
        let renderQueue = [];
        let isRendering = false;

        // --- ì—ëŸ¬ ì²˜ë¦¬ í•¨ìˆ˜ ---
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        // --- ì„±ëŠ¥ ìµœì í™”ëœ ë Œë”ë§ ---
        function queueRender() {
            if (!isRendering) {
                isRendering = true;
                requestAnimationFrame(() => {
                    renderCanvas();
                    isRendering = false;
                });
            }
        }

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            for (let word of words) {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && currentLine !== '') {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            }
            if (currentLine) {
                lines.push(currentLine);
            }

            // í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
            const totalHeight = lines.length * lineHeight;
            const startY = y - (totalHeight / 2) + (lineHeight / 2);
            
            lines.forEach((line, index) => {
                ctx.fillText(line, x, startY + (index * lineHeight));
            });

            return lines.length;
        }

        function getOptimalFontSize(ctx, texts, maxWidth, maxHeight) {
            let fontSize = 48;
            const minFontSize = 16;
            const lineHeight = fontSize * 1.4;
            
            while (fontSize > minFontSize) {
                ctx.font = `${fontSize}px 'Gowun Dodum', sans-serif`;
                
                let totalHeight = 0;
                let maxTextWidth = 0;
                
                for (let text of texts) {
                    const words = text.split(' ');
                    let currentLine = '';
                    let lineCount = 0;
                    
                    for (let word of words) {
                        const testLine = currentLine + (currentLine ? ' ' : '') + word;
                        const metrics = ctx.measureText(testLine);
                        
                        if (metrics.width > maxWidth && currentLine !== '') {
                            lineCount++;
                            maxTextWidth = Math.max(maxTextWidth, ctx.measureText(currentLine).width);
                            currentLine = word;
                        } else {
                            currentLine = testLine;
                        }
                    }
                    if (currentLine) {
                        lineCount++;
                        maxTextWidth = Math.max(maxTextWidth, ctx.measureText(currentLine).width);
                    }
                    
                    totalHeight += lineCount * (fontSize * 1.4) + 20; // ë©”ì‹œì§€ ê°„ ê°„ê²©
                }
                
                if (totalHeight <= maxHeight && maxTextWidth <= maxWidth) {
                    return fontSize;
                }
                
                fontSize -= 2;
            }
            
            return minFontSize;
        }

        // --- ìº”ë²„ìŠ¤ ë Œë”ë§ ---
        function renderCanvas() {
            try {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ë°°ê²½ ê·¸ë¦¬ê¸°
                if (backgroundImage) {
                    // ì´ë¯¸ì§€ ë°°ê²½
                    const img = new Image();
                    img.onload = function() {
                        try {
                            // ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ë§ê²Œ ì¡°ì •
                            const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
                            const scaledWidth = img.width * scale;
                            const scaledHeight = img.height * scale;
                            const x = (canvas.width - scaledWidth) / 2;
                            const y = (canvas.height - scaledHeight) / 2;
                            
                            ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                            
                            // ë°˜íˆ¬ëª… ì˜¤ë²„ë ˆì´
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            
                            renderTextContent();
                        } catch (error) {
                            console.error('ì´ë¯¸ì§€ ë Œë”ë§ ì˜¤ë¥˜:', error);
                            showError('ì´ë¯¸ì§€ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            renderTextContent();
                        }
                    };
                    img.onerror = function() {
                        console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
                        showError('ì´ë¯¸ì§€ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        renderTextContent();
                    };
                    img.src = backgroundImage;
                } else {
                    // ê·¸ë¼ë°ì´ì…˜ ë°°ê²½
                    const template = templates[selectedTemplate];
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    
                    // CSS ê·¸ë¼ë°ì´ì…˜ì„ Canvas ê·¸ë¼ë°ì´ì…˜ìœ¼ë¡œ ë³€í™˜
                    if (selectedTemplate === 'pastel') {
                        gradient.addColorStop(0, '#fef3c7');
                        gradient.addColorStop(0.5, '#fce7f3');
                        gradient.addColorStop(1, '#dbeafe');
                    } else if (selectedTemplate === 'sunrise') {
                        gradient.addColorStop(0, '#fed7aa');
                        gradient.addColorStop(0.5, '#fecaca');
                        gradient.addColorStop(1, '#fde68a');
                    } else if (selectedTemplate === 'ocean') {
                        gradient.addColorStop(0, '#bfdbfe');
                        gradient.addColorStop(0.5, '#a7f3d0');
                        gradient.addColorStop(1, '#c7d2fe');
                    } else if (selectedTemplate === 'pink') {
                        gradient.addColorStop(0, '#fce7f3');
                        gradient.addColorStop(0.5, '#fed7e2');
                        gradient.addColorStop(1, '#fef3c7');
                    } else if (selectedTemplate === 'nature') {
                        gradient.addColorStop(0, '#d1fae5');
                        gradient.addColorStop(0.5, '#a7f3d0');
                        gradient.addColorStop(1, '#fef3c7');
                    } else if (selectedTemplate === 'purple') {
                        gradient.addColorStop(0, '#e0e7ff');
                        gradient.addColorStop(0.5, '#c7d2fe');
                        gradient.addColorStop(1, '#fce7f3');
                    }
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    renderTextContent();
                }
            } catch (error) {
                console.error('ìº”ë²„ìŠ¤ ë Œë”ë§ ì˜¤ë¥˜:', error);
                showError('ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function renderTextContent() {
            try {
                const template = templates[selectedTemplate];
                ctx.fillStyle = template.textColor;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const toText = inputTo.value || "ì†Œì¤‘í•œ ë‹¹ì‹ ì—ê²Œ";
                const fromText = inputFrom.value || "ë§ˆìŒì„ ë‹´ì•„";
                const messages = selectedPhrases.filter(p => p && p.trim() !== '');
                
                // í…ìŠ¤íŠ¸ ë°°ì¹˜
                const margin = 40;
                const topAreaHeight = 80;
                const bottomAreaHeight = 80;
                const messageAreaHeight = canvas.height - topAreaHeight - bottomAreaHeight - (margin * 2);
                
                // ë°›ëŠ” ì‚¬ëŒ (ìƒë‹¨)
                ctx.font = '28px "Gowun Dodum", sans-serif';
                ctx.fillText(toText, canvas.width / 2, margin + topAreaHeight / 2);
                
                // ë³´ë‚´ëŠ” ì‚¬ëŒ (í•˜ë‹¨)
                ctx.fillText(fromText, canvas.width / 2, canvas.height - margin - bottomAreaHeight / 2);
                
                // ë©”ì‹œì§€ë“¤ (ì¤‘ì•™)
                if (messages.length > 0) {
                    const maxWidth = canvas.width - (margin * 2);
                    const fontSize = getOptimalFontSize(ctx, messages, maxWidth, messageAreaHeight);
                    ctx.font = `${fontSize}px "Gowun Dodum", sans-serif`;
                    
                    const lineHeight = fontSize * 1.4;
                    const messageSpacing = 30;
                    const startY = margin + topAreaHeight + (messageAreaHeight / 2);
                    
                    // ì´ ë†’ì´ ê³„ì‚°
                    let totalHeight = 0;
                    const lineCounts = messages.map(message => {
                        const words = message.split(' ');
                        let currentLine = '';
                        let lineCount = 0;
                        
                        for (let word of words) {
                            const testLine = currentLine + (currentLine ? ' ' : '') + word;
                            const metrics = ctx.measureText(testLine);
                            
                            if (metrics.width > maxWidth && currentLine !== '') {
                                lineCount++;
                                currentLine = word;
                            } else {
                                currentLine = testLine;
                            }
                        }
                        if (currentLine) lineCount++;
                        return lineCount;
                    });
                    
                    totalHeight = lineCounts.reduce((sum, count) => sum + count * lineHeight, 0) + 
                                 (messages.length - 1) * messageSpacing;
                    
                    let currentY = startY - (totalHeight / 2);
                    
                    messages.forEach((message, index) => {
                        const messageLines = lineCounts[index];
                        const messageHeight = messageLines * lineHeight;
                        
                        // ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼
                        const isCustom = (selectedPhrases.indexOf(message) === MAX_SLOTS - 1);
                        if (isCustom) {
                            ctx.fillStyle = '#0d9488';
                            ctx.font = `italic ${fontSize}px "Gowun Dodum", sans-serif`;
                        } else {
                            ctx.fillStyle = template.textColor;
                            ctx.font = `${fontSize}px "Gowun Dodum", sans-serif`;
                        }
                        
                        wrapText(ctx, message, canvas.width / 2, currentY + messageHeight / 2, maxWidth, lineHeight);
                        currentY += messageHeight + messageSpacing;
                    });
                }
            } catch (error) {
                console.error('í…ìŠ¤íŠ¸ ë Œë”ë§ ì˜¤ë¥˜:', error);
                showError('í…ìŠ¤íŠ¸ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // --- í…œí”Œë¦¿ ì„ íƒ ì²˜ë¦¬ ---
        function updateTemplateSelection(selectedTemplate) {
            const templateCards = document.querySelectorAll('.template-card');
            templateCards.forEach(card => {
                const isSelected = card.dataset.template === selectedTemplate;
                card.classList.toggle('selected', isSelected);
                card.setAttribute('aria-checked', isSelected);
                card.setAttribute('tabindex', isSelected ? '0' : '-1');
            });
        }

        // --- ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ìˆ˜ì •) ---
        function renderCombinationSlots() {
            combinationBox.innerHTML = '';
            
            // ì¼ë°˜ ìŠ¬ë¡¯ 4ê°œ ìƒì„±
            for (let i = 0; i < MAX_SLOTS - 1; i++) {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'slot-item flex items-center gap-3 p-3 bg-gray-50 rounded-lg min-h-[3.5rem] border';
                slotDiv.setAttribute('data-index', i);
                slotDiv.setAttribute('role', 'listitem');
                slotDiv.innerHTML = `
                    <span class="font-bold text-lg text-gray-500">${i + 1}.</span>
                    <p class="slot-content flex-1 text-lg font-dodum text-gray-800 min-h-[1.5rem]"></p>
                    <button class="clear-btn hidden text-red-400 hover:text-red-600 font-bold text-2xl transition-colors focus:outline-none focus:ring-2 focus:ring-red-400" aria-label="ì´ ë©”ì‹œì§€ ì‚­ì œ">Ã—</button>
                `;
                combinationBox.appendChild(slotDiv);
            }
            
            // ì»¤ìŠ¤í…€ ì…ë ¥ ìŠ¬ë¡¯ (5ë²ˆì§¸)
            const customSlot = document.createElement('div');
            customSlot.className = 'slot-item flex items-center gap-3 p-3 bg-teal-50 rounded-lg min-h-[3.5rem] border-2 border-dashed border-teal-400';
            customSlot.setAttribute('data-index', MAX_SLOTS - 1);
            customSlot.setAttribute('role', 'listitem');
            customSlot.innerHTML = `
                <span class="font-bold text-lg text-teal-600">${MAX_SLOTS}.</span>
                <div class="slot-content custom-editable flex-1 focus:outline-none text-lg font-dodum text-teal-800 focus:ring-2 focus:ring-teal-400 rounded px-2 py-1" 
                     contenteditable="true" 
                     placeholder="âœ¨ ì—¬ê¸°ì— ë‚˜ë§Œì˜ íŠ¹ë³„í•œ ë©”ì‹œì§€ë¥¼ ì§ì ‘ ì¨ë³´ì„¸ìš”! âœ¨"
                     aria-label="ë‚˜ë§Œì˜ ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ì…ë ¥"></div>
                <button class="clear-btn hidden text-red-400 hover:text-red-600 font-bold text-2xl transition-colors focus:outline-none focus:ring-2 focus:ring-red-400" aria-label="ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ì‚­ì œ">Ã—</button>
            `;
            combinationBox.appendChild(customSlot);
            
            addSlotEventListeners();
            updateCombinationBox();
        }

        function updateCombinationBox() {
            let filledSlots = 0;
            const slotItems = combinationBox.querySelectorAll('.slot-item');
            
            slotItems.forEach((slotItem, index) => {
                const slotContent = slotItem.querySelector('.slot-content');
                const clearBtn = slotItem.querySelector('.clear-btn');
                const phrase = selectedPhrases[index];
                
                // ë‚´ìš© ì—…ë°ì´íŠ¸
                if (slotContent.isContentEditable) {
                    if (phrase && document.activeElement !== slotContent) {
                        slotContent.textContent = phrase;
                    }
                } else {
                    slotContent.textContent = phrase || '';
                }

                // í´ë¦¬ì–´ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
                if (phrase && phrase.trim() !== '') {
                    clearBtn.classList.remove('hidden');
                    filledSlots++;
                    slotItem.classList.remove('bg-gray-50');
                    slotItem.classList.add('bg-green-50', 'border-green-200');
                } else {
                    clearBtn.classList.add('hidden');
                    if (!slotContent.isContentEditable) {
                        slotItem.classList.remove('bg-green-50', 'border-green-200');
                        slotItem.classList.add('bg-gray-50');
                    }
                }
            });
            
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            slotStatus.textContent = `(${filledSlots}/${MAX_SLOTS})`;
            btnDownload.disabled = selectedPhrases.every(p => !p || p.trim() === '');

            // ì¶”ê°€ ë²„íŠ¼ ê´€ë¦¬
            const isFull = filledSlots >= MAX_SLOTS;
            btnAddPhrase.disabled = isFull;
            if (isFull && currentDrawnPhrase) {
                btnAddPhrase.classList.add('hidden');
            }
            
            // ìº”ë²„ìŠ¤ ì—…ë°ì´íŠ¸ (ì„±ëŠ¥ ìµœì í™”)
            queueRender();
        }

        function handleSpin() {
            if (isSpinning) return;
            isSpinning = true;
            currentDrawnPhrase = '';
            
            needle.style.transform = `rotate(${Math.random() * 360 + 1080}deg)`;
            todaysPhrase.textContent = "ëŒì•„ê°€ëŠ” ì¤‘...";
            btnAddPhrase.classList.add('hidden');
            btnSpin.disabled = true;

            setTimeout(() => {
                const randomIndex = Math.floor(Math.random() * positivePhrases.length);
                currentDrawnPhrase = positivePhrases[randomIndex];
                todaysPhrase.textContent = currentDrawnPhrase;
                isSpinning = false;
                btnSpin.disabled = false;
                
                const filledSlots = selectedPhrases.filter(p => p && p.trim() !== '').length;
                if (filledSlots < MAX_SLOTS) {
                    btnAddPhrase.classList.remove('hidden');
                }
            }, 2000);
        }

        function addPhrase() {
            if (isSpinning || !currentDrawnPhrase) return;

            const firstEmptyIndex = selectedPhrases.findIndex(p => !p || p.trim() === '');
            if (firstEmptyIndex !== -1) {
                selectedPhrases[firstEmptyIndex] = currentDrawnPhrase;
                
                setTimeout(() => {
                    const slotItems = combinationBox.querySelectorAll('.slot-item');
                    const targetSlot = slotItems[firstEmptyIndex];
                    targetSlot.classList.add('slot-added');
                    setTimeout(() => {
                        targetSlot.classList.remove('slot-added');
                    }, 600);
                }, 50);
                
                updateCombinationBox();
                
                btnAddPhrase.textContent = 'âœ… ì¶”ê°€ë¨!';
                btnAddPhrase.disabled = true;
                setTimeout(() => {
                    btnAddPhrase.textContent = 'â• ì´ ë¬¸êµ¬ ì¶”ê°€í•˜ê¸°';
                    btnAddPhrase.disabled = false;
                    
                    const filledSlots = selectedPhrases.filter(p => p && p.trim() !== '').length;
                    if (filledSlots >= MAX_SLOTS) {
                        btnAddPhrase.classList.add('hidden');
                    }
                }, 1000);
            }
        }
        
        function clearSlot(index) {
            selectedPhrases[index] = '';
            
            if (index === MAX_SLOTS - 1) {
                const customEditable = document.querySelector('.custom-editable');
                if (customEditable) {
                    customEditable.textContent = '';
                }
            }
            
            updateCombinationBox();
            
            if (currentDrawnPhrase && !btnAddPhrase.classList.contains('hidden')) {
                btnAddPhrase.classList.remove('hidden');
            }
        }

        function resetAll() {
            selectedPhrases = new Array(MAX_SLOTS).fill('');
            currentDrawnPhrase = '';
            inputTo.value = '';
            inputFrom.value = '';
            todaysPhrase.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”!";
            btnAddPhrase.classList.add('hidden');
            btnAddPhrase.textContent = 'â• ì´ ë¬¸êµ¬ ì¶”ê°€í•˜ê¸°';
            btnAddPhrase.disabled = false;
            
            // ì´ë¯¸ì§€ ì´ˆê¸°í™”
            backgroundImage = null;
            imagePreview.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
            imageInput.value = '';
            
            const customEditable = document.querySelector('.custom-editable');
            if (customEditable) {
                customEditable.textContent = '';
            }
            
            hideError();
            updateCombinationBox();
        }

        function addSlotEventListeners() {
            const clearBtns = combinationBox.querySelectorAll('.clear-btn');
            clearBtns.forEach((btn, index) => {
                btn.addEventListener('click', () => clearSlot(index));
            });
            
            const customEditable = document.querySelector('.custom-editable');
            if (customEditable) {
                const debouncedUpdate = debounce(() => {
                    selectedPhrases[MAX_SLOTS - 1] = customEditable.textContent.trim();
                    updateCombinationBox();
                }, 300);

                customEditable.addEventListener('input', debouncedUpdate);
                
                customEditable.addEventListener('blur', () => {
                    selectedPhrases[MAX_SLOTS - 1] = customEditable.textContent.trim();
                    updateCombinationBox();
                });

                // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
                customEditable.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        customEditable.blur();
                    }
                });
            }
        }

        function downloadCanvas() {
            try {
                const link = document.createElement('a');
                link.download = `ê¸ì •ì¹´ë“œ_${new Date().getTime()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('ì¹´ë“œ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function validateImageFile(file) {
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            
            if (!allowedTypes.includes(file.type)) {
                showError('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. JPG, PNG, GIF, WebP íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return false;
            }
            
            if (file.size > MAX_FILE_SIZE) {
                showError('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return false;
            }
            
            return true;
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file && validateImageFile(file)) {
                handleImageFile(file);
            }
        }

        function handleImageFile(file) {
            const reader = new FileReader();
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            imageUploadArea.classList.add('loading');
            
            reader.onload = (e) => {
                try {
                    backgroundImage = e.target.result;
                    previewImg.src = backgroundImage;
                    uploadPlaceholder.classList.add('hidden');
                    imagePreview.classList.remove('hidden');
                    imageUploadArea.classList.remove('loading');
                    hideError();
                    queueRender();
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    showError('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    imageUploadArea.classList.remove('loading');
                }
            };
            
            reader.onerror = () => {
                console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜');
                showError('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                imageUploadArea.classList.remove('loading');
            };
            
            reader.readAsDataURL(file);
        }

        function removeImage() {
            backgroundImage = null;
            imagePreview.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
            imageInput.value = '';
            queueRender();
        }

        // --- í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ---
        function handleTemplateKeydown(e) {
            const templateCards = Array.from(document.querySelectorAll('.template-card'));
            const currentIndex = templateCards.findIndex(card => card === document.activeElement);
            
            let nextIndex = currentIndex;
            
            switch (e.key) {
                case 'ArrowRight':
                case 'ArrowDown':
                    e.preventDefault();
                    nextIndex = (currentIndex + 1) % templateCards.length;
                    break;
                case 'ArrowLeft':
                case 'ArrowUp':
                    e.preventDefault();
                    nextIndex = (currentIndex - 1 + templateCards.length) % templateCards.length;
                    break;
                case 'Enter':
                case ' ':
                    e.preventDefault();
                    const template = templateCards[currentIndex].dataset.template;
                    selectedTemplate = template;
                    updateTemplateSelection(template);
                    queueRender();
                    return;
            }
            
            if (nextIndex !== currentIndex) {
                templateCards[nextIndex].focus();
            }
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        document.addEventListener('DOMContentLoaded', () => {
            // ê¸°ë³¸ í…œí”Œë¦¿ ì„ íƒ
            updateTemplateSelection('pastel');
            
            btnSpin.addEventListener('click', handleSpin);
            btnAddPhrase.addEventListener('click', addPhrase);
            btnDownload.addEventListener('click', downloadCanvas);
            btnCreateNew.addEventListener('click', resetAll);
            
            // ì…ë ¥ í•„ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ë””ë°”ìš´ìŠ¤ ì ìš©)
            const debouncedRender = debounce(queueRender, 300);
            inputTo.addEventListener('input', debouncedRender);
            inputFrom.addEventListener('input', debouncedRender);
            
            // í…œí”Œë¦¿ ì„ íƒ
            templateSelection.addEventListener('click', (e) => {
                const templateCard = e.target.closest('.template-card');
                if (templateCard) {
                    selectedTemplate = templateCard.dataset.template;
                    updateTemplateSelection(selectedTemplate);
                    queueRender();
                }
            });

            // í…œí”Œë¦¿ í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
            templateSelection.addEventListener('keydown', handleTemplateKeydown);
            
            // ì´ë¯¸ì§€ ì—…ë¡œë“œ
            imageUploadArea.addEventListener('click', () => imageInput.click());
            imageUploadArea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    imageInput.click();
                }
            });
            
            imageInput.addEventListener('change', handleImageUpload);
            removeImageBtn.addEventListener('click', removeImage);
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­
            imageUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageUploadArea.classList.add('dragover');
            });
            
            imageUploadArea.addEventListener('dragleave', () => {
                imageUploadArea.classList.remove('dragover');
            });
            
            imageUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                imageUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && validateImageFile(files[0])) {
                    handleImageFile(files[0]);
                }
            });
            
            // ì „ì—­ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideError();
                }
                
                // Ctrl+Enterë¡œ ìŠ¤í•€
                if (e.ctrlKey && e.key === 'Enter' && !isSpinning) {
                    handleSpin();
                }
            });
            
            renderCombinationSlots();
            queueRender();
        });
    </script>
</body>
</html>